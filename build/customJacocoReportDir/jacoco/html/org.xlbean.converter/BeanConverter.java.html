<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BeanConverter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">xlbean</a> &gt; <a href="index.source.html" class="el_package">org.xlbean.converter</a> &gt; <span class="el_source">BeanConverter.java</span></div><h1>BeanConverter.java</h1><pre class="source lang-java linenums">package org.xlbean.converter;

import java.beans.IntrospectionException;
import java.beans.Introspector;
import java.beans.PropertyDescriptor;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.xlbean.XlBean;
import org.xlbean.XlList;
import org.xlbean.util.XlBeanFactory;

/**
 * Converter for {@link XlBean} to generic class or vice-versa.
 * 
 * @author Kazuya Tanikawa
 *
 */
<span class="fc" id="L27">public class BeanConverter {</span>

<span class="fc" id="L29">    private ValueConverter converter = new ValueConverter();</span>

    /**
     * Convert the object retrieved by the given sourceKey to an object of given
     * destinationClass.
     * 
     * @param sourceKey
     * @param destinationClazz
     * @return
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt; T toBean(Object srcObj, Class&lt;?&gt; destinationClazz) {
<span class="nc" id="L41">        Object dstObj = instantiate(destinationClazz);</span>
<span class="nc bnc" id="L42" title="All 2 branches missed.">        if (srcObj instanceof Map) {</span>
<span class="nc" id="L43">            Map&lt;String, Object&gt; map = (Map&lt;String, Object&gt;) srcObj;</span>
<span class="nc" id="L44">            return (T) toBean(map, dstObj);</span>
        }
<span class="nc" id="L46">        return (T) dstObj;</span>
    }

    /**
     * Convert {@code srcList} to {@link ArrayList}. If {@code srcList} is not
     * an instance of {@link Iterable}, then it returns blank {@link ArrayList}.
     * 
     * @param srcList
     * @param beanClass
     * @return
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt; List&lt;T&gt; toBeanList(Object srcList, Class&lt;?&gt; beanClass) {
<span class="nc" id="L59">        List&lt;T&gt; retList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (srcList instanceof Iterable) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            for (Object obj : (Iterable&lt;?&gt;) srcList) {</span>
<span class="nc" id="L62">                retList.add(toBean((Map&lt;String, Object&gt;) obj, beanClass));</span>
<span class="nc" id="L63">            }</span>
        }
<span class="nc" id="L65">        return retList;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt; T toBean(Map&lt;String, Object&gt; sourceMap, Class&lt;?&gt; destinationClass) {
<span class="fc" id="L70">        return (T) toBean(sourceMap, instantiate(destinationClass));</span>
    }

<span class="fc" id="L73">    private Map&lt;Class&lt;?&gt;, Map&lt;String, PropertyDescriptor&gt;&gt; classPropertyDescriptorMap = new HashMap&lt;&gt;();</span>

    protected PropertyDescriptor getPropertyDescriptor(Class&lt;?&gt; clazz, String propertyName) {
<span class="fc" id="L76">        Map&lt;String, PropertyDescriptor&gt; propertyDescriptorMap = classPropertyDescriptorMap.get(clazz);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if (propertyDescriptorMap == null) {</span>
<span class="fc" id="L78">            propertyDescriptorMap = new HashMap&lt;&gt;();</span>
            try {
<span class="fc" id="L80">                List&lt;PropertyDescriptor&gt; propertyList = Arrays.asList(Introspector.getBeanInfo(clazz)</span>
<span class="fc" id="L81">                        .getPropertyDescriptors());</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">                for (PropertyDescriptor pd : propertyList) {</span>
<span class="fc" id="L84">                    propertyDescriptorMap.put(pd.getName(), pd);</span>
<span class="fc" id="L85">                }</span>
<span class="nc" id="L86">            } catch (IntrospectionException e) {</span>
<span class="nc" id="L87">                throw new RuntimeException(e);</span>
<span class="fc" id="L88">            }</span>
        }
<span class="fc" id="L90">        return propertyDescriptorMap.get(propertyName);</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt; T toBean(Map&lt;String, Object&gt; sourceMap, Object destinationObj) {
<span class="fc bfc" id="L95" title="All 2 branches covered.">        for (Entry&lt;String, Object&gt; entry : sourceMap.entrySet()) {</span>
            try {
<span class="fc" id="L97">                PropertyDescriptor pd = getPropertyDescriptor(destinationObj.getClass(), entry.getKey());</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">                if (pd == null) {</span>
<span class="fc" id="L99">                    continue;</span>
                }
<span class="fc" id="L101">                Method setter = pd.getWriteMethod();</span>
<span class="fc" id="L102">                Class&lt;?&gt; type = pd.getPropertyType();</span>

<span class="fc" id="L104">                Object value = entry.getValue();</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                if (value == null) {</span>
<span class="nc" id="L106">                    continue;</span>
                }
<span class="fc bfc" id="L108" title="All 2 branches covered.">                if (value instanceof Map) {</span>
                    // If a value of sourceMap is Map and field to be mapped is
                    // not a leaf class,
                    // then this value could be mapped to some bean.
<span class="fc" id="L112">                    Object obj = toBean((Map&lt;String, Object&gt;) value, type);</span>
<span class="fc" id="L113">                    setter.invoke(destinationObj, obj);</span>
<span class="pc bpc" id="L114" title="1 of 4 branches missed.">                } else if (Iterable.class.isAssignableFrom(value.getClass()) &amp;&amp; Iterable.class.isAssignableFrom(type)) {</span>
<span class="fc" id="L115">                    List&lt;Object&gt; obj = (List&lt;Object&gt;) instantiate(pd.getPropertyType()</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                            .isInterface() ? ArrayList.class : type);</span>
<span class="fc" id="L117">                    ParameterizedType p = (ParameterizedType) pd.getWriteMethod()</span>
<span class="fc" id="L118">                            .getGenericParameterTypes()[0];</span>
<span class="fc" id="L119">                    Type childType = p.getActualTypeArguments()[0];</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">                    for (Object srcObj : (Iterable&lt;?&gt;) value) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                        if (isLeaf(srcObj.getClass())) {</span>
<span class="nc" id="L122">                            obj.add(srcObj);</span>
                        } else {
<span class="fc" id="L124">                            Object bean = toBean((Map&lt;String, Object&gt;) srcObj, Class.forName(childType.getTypeName()));</span>
<span class="fc" id="L125">                            obj.add(bean);</span>
                        }
<span class="fc" id="L127">                    }</span>
<span class="fc" id="L128">                    setter.invoke(destinationObj, obj);</span>
<span class="fc" id="L129">                } else {</span>
                    // If a value is neither Map or List, then it should be
                    // String.
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">                    Object convertedValue = converter</span>
<span class="pc" id="L133">                            .toObject(value instanceof String ? (String) value : value.toString(), type);</span>
<span class="fc" id="L134">                    setter.invoke(destinationObj, convertedValue);</span>
                }
<span class="nc" id="L136">            } catch (ClassNotFoundException | InvocationTargetException | IllegalAccessException e) {</span>
<span class="nc" id="L137">                throw new RuntimeException(e);</span>
<span class="fc" id="L138">            }</span>
<span class="fc" id="L139">        }</span>
<span class="fc" id="L140">        return (T) destinationObj;</span>
    }

    private boolean isLeaf(Class&lt;?&gt; clazz) {
<span class="fc" id="L144">        return converter.canConvert(clazz);</span>
    }

    private Object instantiate(Class&lt;?&gt; clazz) {
        try {
<span class="fc" id="L149">            return clazz.newInstance();</span>
<span class="nc" id="L150">        } catch (InstantiationException | IllegalAccessException e) {</span>
<span class="nc" id="L151">            throw new RuntimeException(e);</span>
        }
    }

    public Object toMap(Object value) {
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L157">            return null;</span>
        }
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (value instanceof Map) {</span>
<span class="fc" id="L160">            XlBean xlBean = XlBeanFactory.getInstance()</span>
<span class="fc" id="L161">                    .createBean();</span>
<span class="fc" id="L162">            Map&lt;?, ?&gt; map = (Map&lt;?, ?&gt;) value;</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            for (Entry&lt;?, ?&gt; entry : map.entrySet()) {</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">                if (entry.getKey() == null) {</span>
<span class="nc" id="L165">                    continue;</span>
                }
<span class="fc" id="L167">                String mapKey = entry.getKey()</span>
<span class="fc" id="L168">                        .toString();</span>
<span class="fc" id="L169">                Object mapValue = toMap(entry.getValue());</span>
<span class="fc" id="L170">                xlBean.put(mapKey, mapValue);</span>
<span class="fc" id="L171">            }</span>
<span class="fc" id="L172">            return xlBean;</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">        } else if (value instanceof Iterable) {</span>
<span class="fc" id="L174">            XlList xlList = XlBeanFactory.getInstance()</span>
<span class="fc" id="L175">                    .createList();</span>
<span class="fc" id="L176">            List&lt;?&gt; list = (List&lt;?&gt;) value;</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">            for (Object elem : list) {</span>
<span class="fc" id="L178">                Object val = toMap(elem);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                if (val instanceof XlBean) {</span>
<span class="fc" id="L180">                    xlList.add((XlBean) val);</span>
                } else {
<span class="nc" id="L182">                    XlBean elemBean = XlBeanFactory.getInstance()</span>
<span class="nc" id="L183">                            .createBean();</span>
<span class="nc" id="L184">                    elemBean.put(&quot;value&quot;, val);</span>
<span class="nc" id="L185">                    xlList.add(elemBean);</span>
                }
<span class="fc" id="L187">            }</span>
<span class="fc" id="L188">            return xlList;</span>
        } else {
<span class="fc bfc" id="L190" title="All 2 branches covered.">            if (converter.canConvert(value.getClass())) {</span>
<span class="fc" id="L191">                return converter.toString(value);</span>
            } else {
<span class="fc" id="L193">                return toMapInternal(value);</span>
            }
        }
    }

    private XlBean toMapInternal(Object obj) {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (obj == null) {</span>
<span class="nc" id="L200">            return null;</span>
        }
<span class="fc" id="L202">        XlBean retBean = XlBeanFactory.getInstance()</span>
<span class="fc" id="L203">                .createBean();</span>
        try {
<span class="fc bfc" id="L205" title="All 2 branches covered.">            for (PropertyDescriptor pd : Introspector.getBeanInfo(obj.getClass())</span>
<span class="fc" id="L206">                    .getPropertyDescriptors()) {</span>
<span class="fc" id="L207">                String name = pd.getName();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">                if (&quot;class&quot;.equals(name)) {</span>
<span class="fc" id="L209">                    continue;</span>
                }
<span class="fc" id="L211">                Object value = pd.getReadMethod()</span>
<span class="fc" id="L212">                        .invoke(obj, (Object[]) null);</span>
<span class="fc" id="L213">                retBean.put(name, toMap(value));</span>
            }
<span class="nc" id="L215">        } catch (IntrospectionException | IllegalAccessException | IllegalArgumentException</span>
                | InvocationTargetException e) {
<span class="nc" id="L217">            throw new RuntimeException(e);</span>
<span class="fc" id="L218">        }</span>
<span class="fc" id="L219">        return retBean;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>