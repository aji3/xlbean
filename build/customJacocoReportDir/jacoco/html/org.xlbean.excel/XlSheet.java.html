<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ja"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>XlSheet.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">xlbean</a> &gt; <a href="index.source.html" class="el_package">org.xlbean.excel</a> &gt; <span class="el_source">XlSheet.java</span></div><h1>XlSheet.java</h1><pre class="source lang-java linenums">package org.xlbean.excel;

import java.math.BigDecimal;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellType;
import org.apache.poi.ss.usermodel.Comment;
import org.apache.poi.ss.usermodel.CreationHelper;
import org.apache.poi.ss.usermodel.DataFormatter;
import org.apache.poi.ss.usermodel.FormulaEvaluator;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.util.CellAddress;

/**
 * Wrapper class of {@link Sheet}.
 * 
 * @author Kazuya Tanikawa
 *
 */
public class XlSheet {

<span class="fc" id="L28">    public enum ValueType {</span>
<span class="fc" id="L29">        def, string, data, date,</span>
    };

    private Sheet sheet;

    /**
     * Cache for performance.
     */
    private FormulaEvaluator evaluator;

<span class="fc" id="L39">    public XlSheet(Sheet sheet) {</span>
<span class="fc" id="L40">        this.sheet = sheet;</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (sheet != null) {</span>
<span class="fc" id="L42">            Workbook wb = sheet.getWorkbook();</span>
<span class="fc" id="L43">            CreationHelper creationHelper = wb.getCreationHelper();</span>
<span class="fc" id="L44">            this.evaluator = creationHelper.createFormulaEvaluator();</span>
        }
<span class="fc" id="L46">    }</span>

    public String getSheetName() {
<span class="fc" id="L49">        return sheet.getSheetName();</span>
    }

    public String getCellValue(XlCellAddress address) {
<span class="nc" id="L53">        return getCellValue(address, null);</span>
    }

    public String getCellValue(XlCellAddress address, ValueType type) {
<span class="nc" id="L57">        return getCellValue(address.getRow(), address.getColumn(), type);</span>
    }

    public String getCellValue(int row, int col) {
<span class="fc" id="L61">        return getCellValue(row, col, null);</span>
    }

    /**
     * Get value of the cell as it looks.
     * 
     * @param row
     * @param col
     * @return
     */
    public String getCellValue(int row, int col, ValueType type) {
<span class="fc" id="L72">        Cell cell = getCell(row, col);</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (cell == null) {</span>
<span class="fc" id="L74">            return null;</span>
        } else {
<span class="fc" id="L76">            return getCellValue(cell, type);</span>
        }
    }
    
    /**
     * &lt;p&gt;
     * {@link Cell#getCellTypeEnum} is used because this method is to be
     * replaced by existing method in the future version.
     * &lt;/p&gt;
     * 
     * @param cell
     * @return
     */
    public String getCellValue(Cell cell, ValueType type) {
<span class="fc" id="L90">        CellType cellType = null;</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (CellType.FORMULA.equals(cell.getCellTypeEnum())) {</span>
            // Do not use evaluateInCell, as this method updates a cell 
            // when it evaluates the cell so that it is very slow.
<span class="fc" id="L94">            cellType = evaluator.evaluateFormulaCellEnum(cell);</span>
        } else {
<span class="fc" id="L96">            cellType = cell.getCellTypeEnum();</span>
        }
<span class="pc bpc" id="L98" title="1 of 4 branches missed.">        if (type == null || ValueType.def.equals(type)) {</span>
<span class="fc" id="L99">            return getCellValueAsData(cell, cellType, false);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        } else if (ValueType.string.equals(type)) {</span>
<span class="fc" id="L101">            return getCellValueAsPresented(cell);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        } else if (ValueType.data.equals(type)) {</span>
<span class="nc" id="L103">            return getCellValueAsData(cell, cellType, false);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        } else if (ValueType.date.equals(type)) {</span>
<span class="nc" id="L105">            return getCellValueAsData(cell, cellType, true);</span>
        } else {
<span class="nc" id="L107">            return null;</span>
        }
    }

    public String getCellComment(int row, int col) {
<span class="fc" id="L112">        Comment comment = sheet.getCellComment(new CellAddress(row, col));</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (comment == null) {</span>
<span class="fc" id="L114">            return null;</span>
        } else {
<span class="fc" id="L116">            return comment.getString().toString();</span>
        }
    }
    
    public void setCellValue(XlCellAddress address, String value) {
<span class="nc" id="L121">        setCellValue(address.getRow(), address.getColumn(), value);</span>
<span class="nc" id="L122">    }</span>

    public void setCellValue(int row, int col, String value) {
<span class="fc" id="L125">        setCellValue(row, col, value, null);</span>
<span class="fc" id="L126">    }</span>

    public void setCellValue(int row, int col, String value, ValueType type) {
<span class="fc" id="L129">        Cell cell = getCell(row, col, true);</span>
<span class="fc" id="L130">        setCellValue(cell, value, type);</span>
<span class="fc" id="L131">    }</span>

    public void setCellValue(Cell cell, String value, ValueType type) {
<span class="pc bpc" id="L134" title="1 of 4 branches missed.">        if (type == null || ValueType.def.equals(type)) {</span>
<span class="fc" id="L135">            setCellValueAsData(cell, value, false);</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">        } else if (ValueType.date.equals(type)) {</span>
<span class="nc" id="L137">            setCellValueAsData(cell, value, true);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        } else if (ValueType.string.equals(type)) {</span>
<span class="fc" id="L139">            setCellValueAsString(cell, value);</span>
        } else {
<span class="nc" id="L141">            setCellValueAsData(cell, value, false);</span>
        }
<span class="fc" id="L143">    }</span>
    
    protected void setCellValueAsString(Cell cell, String value) {
<span class="pc bpc" id="L146" title="1 of 4 branches missed.">        if (cell == null || value == null) {</span>
<span class="fc" id="L147">            return;</span>
        }
<span class="fc" id="L149">        cell.setCellValue(value);</span>
<span class="fc" id="L150">    }</span>

    protected void setCellValueAsData(Cell cell, String value, boolean forceDate) {
<span class="pc bpc" id="L153" title="1 of 4 branches missed.">        if (cell == null || value == null) {</span>
<span class="fc" id="L154">            return;</span>
        }
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if (forceDate) {</span>
<span class="nc" id="L157">            cell.setCellValue(parseDateTimeValue(value));</span>
        } else {
<span class="fc" id="L159">            String dataFormatString = cell.getCellStyle().getDataFormatString();</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">            if (isStringValue(dataFormatString)) {</span>
<span class="fc" id="L161">                cell.setCellValue(value);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            } else if (isDateTimeValue(cell.getCellStyle().getDataFormatString())) {</span>
<span class="fc" id="L163">                cell.setCellValue(parseDateTimeValue(value));</span>
            } else {
                try {
<span class="fc" id="L166">                    cell.setCellValue(Double.parseDouble(value));</span>
<span class="fc" id="L167">                } catch (NumberFormatException e) {</span>
<span class="fc" id="L168">                    cell.setCellValue(value.toString());</span>
<span class="fc" id="L169">                }</span>
            }
        }
<span class="fc" id="L172">    }</span>

    private static final String DATEFORMAT_CHARS = &quot;ymdhs&quot;;

    private boolean isDateTimeValue(String dataFormatString) {
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (dataFormatString == null) {</span>
<span class="nc" id="L178">            return false;</span>
        }
<span class="fc bfc" id="L180" title="All 2 branches covered.">        return dataFormatString.replaceAll(&quot;\\[.*\\]&quot;, &quot;&quot;).chars().anyMatch(c -&gt; DATEFORMAT_CHARS.indexOf(c) &gt;= 0);</span>
    }
    private boolean isStringValue(String dataFormatString) {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (dataFormatString == null) {</span>
<span class="nc" id="L184">            return false;</span>
        }
<span class="fc" id="L186">        return &quot;@&quot;.equals(dataFormatString);</span>
    }

<span class="fc" id="L189">    private static final DateTimeFormatter DATETIME_FORMAT = DateTimeFormatter.ofPattern(&quot;yyyy/MM/dd HH:mm:ss.SSS&quot;);</span>
<span class="fc" id="L190">    private static final DateTimeFormatter TIME_FORMAT = DateTimeFormatter.ofPattern(&quot;HH:mm:ss.SSS&quot;);</span>

    /**
     * Format excel date value which is a differential number from 1900/1/0, to
     * either date-time string(yyyy/MM/dd HH:mm:ss.SSS) or time
     * string(HH:mm:ss.SSS) depends on the {@code value}.
     * 
     * @param value
     * @return
     */
    protected String formatDateTimeValue(double value) {
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (value == 0) {</span>
<span class="nc" id="L202">            return &quot;&quot;;</span>
        } else {
<span class="fc" id="L204">            int days = (int) value;</span>
<span class="fc" id="L205">            long time = (long) (Math.round((value - days) * 86400 * 1000) * 1000000);</span>
<span class="fc" id="L206">            LocalDateTime dateTime = LocalDateTime.of(1899, 12, 30, 0, 0, 0, 0).plusDays((int) value).plusNanos(time);</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">            if (value &lt; 1d) {</span>
                // returns HH:mm:ss.SSS
<span class="fc" id="L209">                return TIME_FORMAT.format(dateTime);</span>
            } else {
                // returns yyyy/MM/dd HH:mm:ss.SSS
<span class="fc" id="L212">                return DATETIME_FORMAT.format(dateTime);</span>
            }
        }
    }

    protected double parseDateTimeValue(String dateTime) {
<span class="pc bpc" id="L218" title="2 of 4 branches missed.">        if (dateTime == null || dateTime.isEmpty()) {</span>
<span class="nc" id="L219">            return 0;</span>
        }
<span class="fc bfc" id="L221" title="All 2 branches covered.">        if (dateTime.length() == 12) {</span>
<span class="fc" id="L222">            LocalTime baseTime = LocalTime.of(0, 0, 0, 0);</span>
<span class="fc" id="L223">            LocalTime time = LocalTime.parse(dateTime, TIME_FORMAT);</span>
<span class="fc" id="L224">            Duration duration = Duration.between(baseTime, time);</span>
<span class="fc" id="L225">            return duration.toNanos() / 1000000000d / 86400d;</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        } else if (dateTime.length() == 23) {</span>
<span class="fc" id="L227">            LocalDateTime baseDate = LocalDateTime.of(1899, 12, 30, 0, 0, 0, 0);</span>
<span class="fc" id="L228">            LocalDateTime date = LocalDateTime.parse(dateTime, DATETIME_FORMAT);</span>
<span class="fc" id="L229">            Duration duration = Duration.between(baseDate, date);</span>
<span class="fc" id="L230">            return duration.toNanos() / 1000000000d / 86400d;</span>
        } else {
<span class="nc" id="L232">            throw new IllegalArgumentException(String.format(&quot;Illegal date time format. [%s]&quot;, dateTime));</span>
        }
    }

    protected String getCellValueAsData(Cell cell, boolean forceDate) {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (CellType.BLANK.equals(cell.getCellTypeEnum())) {</span>
<span class="nc" id="L238">            return null;</span>
        }
        try {
<span class="nc bnc" id="L241" title="All 4 branches missed.">            if (forceDate || isDateTimeValue(cell.getCellStyle().getDataFormatString())) {</span>
<span class="nc" id="L242">                return formatDateTimeValue(cell.getNumericCellValue());</span>
            }
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (CellType.BOOLEAN.equals(cell.getCellTypeEnum())) {</span>
<span class="nc" id="L245">                return String.valueOf(cell.getBooleanCellValue());</span>
            } else {
<span class="nc" id="L247">                return BigDecimal.valueOf(cell.getNumericCellValue()).toPlainString();</span>
            }
<span class="nc" id="L249">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L250">            return cell.getRichStringCellValue().getString();</span>
        }
    }
    /**
     * 
     * 
     * @param cell
     * @param type
     * @param forceDate
     * @return
     */
    protected String getCellValueAsData(Cell cell, CellType type, boolean forceDate) {
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (CellType.BLANK.equals(type)) {</span>
<span class="fc" id="L263">            return null;</span>
        }
        try {
<span class="pc bpc" id="L266" title="1 of 4 branches missed.">            if (forceDate || isDateTimeValue(cell.getCellStyle().getDataFormatString())) {</span>
<span class="fc" id="L267">                return formatDateTimeValue(cell.getNumericCellValue());</span>
            }
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">            if (CellType.BOOLEAN.equals(type)) {</span>
<span class="nc" id="L270">                return String.valueOf(cell.getBooleanCellValue());</span>
            } else {
<span class="fc" id="L272">                return BigDecimal.valueOf(cell.getNumericCellValue()).toPlainString();</span>
            }
<span class="fc" id="L274">        } catch (IllegalStateException e) {</span>
<span class="fc" id="L275">            return cell.getRichStringCellValue().getString();</span>
        }
    }
    protected String getCellValueAsPresented(Cell cell) {
<span class="fc" id="L279">        DataFormatter formatter = new DataFormatter();</span>
<span class="fc" id="L280">        return formatter.formatCellValue(cell);</span>
    }

    private Cell getCell(int row, int col) {
<span class="fc" id="L284">        return getCell(row, col, false);</span>
    }
    
    private Cell getCell(int row, int col, boolean create) {
<span class="fc" id="L288">        Row r = sheet.getRow(row);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        if (r == null) {</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">            if (create) {</span>
<span class="fc" id="L291">                r = sheet.createRow(row);</span>
            } else {
<span class="fc" id="L293">                return null;</span>
            }
        }
<span class="fc" id="L296">        Cell cell = r.getCell(col);</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (cell == null) {</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">            if (create) {</span>
<span class="fc" id="L299">                return r.createCell(col);</span>
            } else {
<span class="fc" id="L301">                return null;</span>
            }
        }
<span class="fc" id="L304">        return cell;</span>
    }

    public int getMaxRow() {
<span class="fc" id="L308">        return sheet.getLastRowNum();</span>
    }

    public int getMaxColumn() {
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">        if (sheet.getRow(0) == null) {</span>
<span class="nc" id="L313">            return 0;</span>
        }
<span class="fc" id="L315">        return sheet.getRow(0).getLastCellNum();</span>
    }
    
    public int getMaxColumn(int row) {
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (sheet.getRow(row) == null) {</span>
<span class="fc" id="L320">            return 0;</span>
        }
<span class="fc" id="L322">        return sheet.getRow(row).getLastCellNum();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>